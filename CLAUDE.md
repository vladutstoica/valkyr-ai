# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Valkyr** is a cross-platform Electron application that orchestrates multiple CLI coding agents (Claude Code, Codex, Qwen Code, Amp, etc.) in parallel. Each agent runs in its own Git worktree to keep changes isolated, allowing simultaneous work on multiple features.

### Architecture

- **Main Process** (`src/main/`): Electron main process — IPC handlers, services, database, PTY management
- **Renderer Process** (`src/renderer/`): React UI built with Vite — components, hooks, terminal panes
- **Shared** (`src/shared/`): Provider registry (20+ agent definitions), shared utilities
- **Database**: SQLite via Drizzle ORM, stored in OS userData folder
- **Worktrees**: Created in sibling `../worktrees/` directory (outside repo root)

### Tech Stack

- **Runtime**: Electron 30.5.1, Node.js 20.0.0+ (recommended: 22.22.0 via `.nvmrc`)
- **Frontend**: React 18, TypeScript 5.3, Vite 5, Tailwind CSS 3
- **Backend**: Node.js, TypeScript, Drizzle ORM, SQLite3
- **Editor**: Monaco Editor 0.55, **Terminal**: xterm.js + node-pty 1.0
- **Native Modules**: node-pty, sqlite3, keytar (require `pnpm run rebuild` after updates)
- **UI**: Radix UI primitives, lucide-react icons

## Development Commands

```bash
# Quick start (installs deps, rebuilds natives, starts dev)
pnpm run d

# Development (runs main + renderer concurrently)
pnpm run dev
pnpm run dev:main     # Electron main process only (tsc + electron)
pnpm run dev:renderer # Vite dev server only (port 3000)

# Quality checks (run before committing)
pnpm run type-check   # TypeScript type checking (uses tsconfig.json — renderer/shared/types)
pnpm run lint         # ESLint
pnpm run format       # Format with Prettier

# Testing
pnpm exec vitest run                                         # Run all tests
pnpm exec vitest run src/test/main/WorktreeService.test.ts   # Run specific test

# Native modules
pnpm run rebuild      # Rebuild native modules for Electron
pnpm run reset        # Clean install (removes node_modules, reinstalls)

# Building & Packaging
pnpm run build        # Build main + renderer
pnpm run package:mac  # macOS .dmg (arm64)
pnpm run package:linux # Linux AppImage/deb (x64)
pnpm run package:win  # Windows nsis/portable (x64)
```

## Critical Rules

- **NEVER modify** `drizzle/meta/` or numbered migration files — always use `drizzle-kit generate`
- **NEVER write migration SQL by hand** — all migrations must be generated by `pnpm exec drizzle-kit generate` after editing `src/main/db/schema.ts`
- **NEVER modify** `build/` entitlements or updater config without review
- **ALWAYS** run `pnpm run type-check` and `pnpm run lint` before committing
- **ALWAYS** use feature branches (never commit directly to `main`)
- Put temporary notes or scratch content in `.notes/` (gitignored)

## Code Organization

### Main Process (`src/main/`)

**Boot sequence**: `entry.ts` → `main.ts` → IPC registration → window creation

- `entry.ts` — Sets app name (must happen before `app.getPath('userData')` is called, or Electron defaults to `~/Library/Application Support/Electron`). Monkey-patches `Module._resolveFilename` to resolve `@shared/*` and `@/*` path aliases at runtime in compiled JS.
- `main.ts` — Loads `.env`, fixes PATH for CLI discovery on macOS/Linux/Windows (adds Homebrew, npm global, nvm paths so agents like `gh`, `codex`, `claude` are found when launched from Finder), then initializes Electron windows and registers all IPC handlers.
- `preload.ts` — Exposes secure `electronAPI` to renderer via `contextBridge`.

**Services** (`src/main/services/`):
- `WorktreeService.ts` — Git worktree lifecycle, file preservation patterns
- `WorktreePoolService.ts` — Worktree pooling/reuse layer
- `DatabaseService.ts` — All SQLite CRUD operations
- `GitHubService.ts` — GitHub integration via `gh` CLI
- `GitService.ts` — Git operations
- `PrGenerationService.ts` — Automated PR generation
- `TerminalConfigParser.ts` — Terminal configuration parsing
- `ptyManager.ts` — PTY (pseudo-terminal) lifecycle management
- `TerminalSnapshotService.ts` — Terminal state persistence
- `AutoUpdateService.ts` — Electron auto-update management
- `ConnectionsService.ts` — External service connections
- `ProjectSettingsService.ts` — Project-level settings
- `LifecycleScriptsService.ts` — Lifecycle script execution
- `LinearService.ts` / `JiraService.ts` — Issue tracker integrations
- `ProjectPrep.ts` — Project preparation logic
- `RepositoryManager.ts` — Repository management

Note: Some IPC handler files are colocated in `services/` (e.g., `worktreeIpc.ts`, `ptyIpc.ts`, `updateIpc.ts`, `lifecycleIpc.ts`, `planLockIpc.ts`, `fsIpc.ts`).

**IPC Handlers** (`src/main/ipc/`):
- 17 handler files: `appIpc`, `dbIpc`, `gitIpc`, `githubIpc`, `browserIpc`, `connectionsIpc`, `projectIpc`, `projectSettingsIpc`, `settingsIpc`, `telemetryIpc`, `lineCommentsIpc`, `linearIpc`, `jiraIpc`, `hostPreviewIpc`, `netIpc`, `debugIpc`, plus `index.ts`
- All return `{ success: boolean, data?: any, error?: string }` format
- Types defined in `src/renderer/types/electron-api.d.ts`

**Database** (`src/main/db/`):
- Schema: `schema.ts` — Migrations: `drizzle/` (auto-generated)
- Locations: macOS `~/Library/Application Support/valkyr/valkyr.db`, Linux `~/.config/valkyr/valkyr.db`, Windows `%APPDATA%\valkyr\valkyr.db`
- Override with `VALKYR_DB_FILE` env var

### Renderer Process (`src/renderer/`)

**Key components** (`components/`):
- `App.tsx` — Root orchestration (very large, ~79KB)
- `EditorMode.tsx` — Monaco code editor
- `ChatInterface.tsx` — Conversation UI
- `FileChangesPanel.tsx` / `ChangesDiffModal.tsx` — Diff visualization and review
- `CommandPalette.tsx` — Command/action palette
- `FileExplorer/` — File tree navigation
- `BrowserPane.tsx` — Webview preview

**Other renderer directories**:
- `hooks/` — Custom React hooks (file operations, keyboard shortcuts, editor decorations, etc.)
- `contexts/` — React context providers
- `lib/` — Utility functions
- `providers/` — Provider-specific components
- `terminal/` — Terminal emulation components
- `types/` — TypeScript type definitions (incl. `electron-api.d.ts`)
- `ui/` — Reusable UI primitives (Radix-based, configured via `components.json`)

### Path Aliases

**Important**: `@/*` resolves differently in main vs renderer:

| Alias | tsconfig.json (renderer) | tsconfig.main.json (main) |
|-------|-------------------------|--------------------------|
| `@/*` | `src/renderer/*` | `src/*` |
| `@shared/*` | `src/shared/*` | `src/shared/*` |
| `#types/*` | `src/types/*` | _(not available)_ |
| `#types` | `src/types/index.ts` | _(not available)_ |

At runtime in compiled main process, `entry.ts` monkey-patches `Module._resolveFilename` to map `@shared/*` → `dist/main/shared/*` and `@/*` → `dist/main/main/*`.

## Architecture Patterns

### IPC Communication

```typescript
// Main process (src/main/ipc/exampleIpc.ts)
ipcMain.handle('example:action', async (_event, args: { id: string }) => {
  try {
    const result = await service.doSomething(args.id);
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
});

// Renderer — call via window.electronAPI
const result = await window.electronAPI.exampleAction({ id: '123' });
```

### Services

Services are singleton classes with a module-level export:
```typescript
export class ExampleService { /* ... */ }
export const exampleService = new ExampleService();
```

## Code Style

- **TypeScript**: Strict mode. Prefer explicit types over `any`. Type imports: `import type { Foo } from './bar'`
- **React**: Functional components with hooks. Named exports preferred. Clean up subscriptions in `useEffect` return.
- **File naming**: Components PascalCase (`FileExplorer.tsx`), other files kebab-case (`use-toast.ts`). Tests: `*.test.ts`
- **Error handling**: Main → `log.error()` from `../lib/logger`, Renderer → `console.error()` or toast, IPC → `{ success: false, error }`
- **Styling**: Tailwind CSS classes

## Database & Migrations

- **ALL migrations MUST be generated via `pnpm exec drizzle-kit generate`** — NEVER write migration SQL files by hand
- Workflow: modify schema in `src/main/db/schema.ts` → run `pnpm exec drizzle-kit generate` → verify the generated SQL → commit both schema and migration
- Browse DB: `pnpm exec drizzle-kit studio`
- **NEVER** manually edit files in `drizzle/meta/` or numbered SQL migrations
- **NEVER** create `.sql` files in `drizzle/` manually — drizzle-kit generates these along with snapshot files that track schema state for future diffs

## Environment Variables

All optional:
- `VALKYR_DB_FILE` — Override database file path
- `VALKYR_DISABLE_NATIVE_DB` — Disable native SQLite driver
- `VALKYR_DISABLE_CLONE_CACHE` — Disable clone caching
- `VALKYR_DISABLE_PTY` — Disable PTY support
- `TELEMETRY_ENABLED` — Toggle anonymous telemetry (PostHog)
- `CODEX_SANDBOX_MODE` / `CODEX_APPROVAL_POLICY` — Codex agent configuration

## Hot Reload

- **Renderer changes**: Hot-reload via Vite
- **Main process changes**: Require Electron restart (Ctrl+C → `pnpm run dev`)
- **Native modules**: Require `pnpm run rebuild`

## Debugging the Running App

Use the **playwright-electron MCP** tools to interact with the running Electron app directly from Claude Code. This is the preferred method for debugging UI issues, verifying state, and inspecting the renderer process.

### Setup — Starting the App with Remote Debugging

**IMPORTANT**: `ELECTRON_EXTRA_LAUNCH_ARGS` does NOT work with this project's `pnpm run dev` script. You MUST start the renderer and electron separately, passing `--remote-debugging-port=9222` directly to the electron binary.

```bash
# Step 1: Build the main process
pnpm exec tsc -p tsconfig.main.json && \
  mkdir -p dist/main && cp src/main/appConfig.json dist/main/appConfig.json && \
  mkdir -p dist/main/main/services/skills && \
  cp src/main/services/skills/bundled-catalog.json dist/main/main/services/skills/bundled-catalog.json

# Step 2: Start renderer (Vite dev server) in background
pnpm run dev:renderer > /tmp/valkyr-renderer.log 2>&1 &

# Step 3: Start electron with remote debugging port passed DIRECTLY to the binary
pnpm exec electron dist/main/main/entry.js --dev --remote-debugging-port=9222 > /tmp/valkyr-main.log 2>&1 &

# Step 4: Wait ~8-10 seconds for startup, then verify CDP is listening
sleep 10
curl -s http://127.0.0.1:9222/json/version | head -3
# Should output JSON with "Browser": "Chrome/..." if successful
```

To **restart after main process changes**:
```bash
# Kill existing processes
pkill -f "Electron dist/main" 2>/dev/null; pkill -f "vite" 2>/dev/null; sleep 2

# Rebuild main and relaunch (repeat Steps 1-4 above)
```

Renderer-only changes hot-reload via Vite — no restart needed.

### Workflow

1. **Connect**: Call `mcp__playwright-electron__browser_snapshot` to connect to the running Electron window.
2. **Inspect UI state**: Use `mcp__playwright-electron__browser_snapshot` to get a DOM accessibility snapshot — shows all visible elements, text, and interactive controls.
3. **Execute JS in renderer**: Use `mcp__playwright-electron__browser_evaluate` to run JavaScript in the renderer context. The `function` parameter must be a string like `() => { return document.title; }`. Useful for:
   - Reading React component state or props
   - Calling `window.electronAPI.*` methods directly
   - Inspecting Zustand/context store values
4. **Click/interact**: Use `mcp__playwright-electron__browser_click` to simulate user interactions (clicking projects, tabs, buttons).
5. **Type text**: Use `mcp__playwright-electron__browser_type` with `submit: true` to type and press Enter.
6. **Read console output**: Use `mcp__playwright-electron__browser_console_messages` to read `console.log` output from the renderer.
7. **Take screenshots**: Use `mcp__playwright-electron__browser_take_screenshot` for visual verification.
8. **Check main process logs**: `tail -50 /tmp/valkyr-main.log` for main process output.

### Tips

- After adding debug `console.log` statements to renderer source files, Vite HMR will hot-reload — no restart needed.
- Always clean up debug logs after investigation.
- The app runs on `http://localhost:3000` (Vite dev server) inside Electron.
- Main process logs go to `/tmp/valkyr-main.log`, renderer logs to `/tmp/valkyr-renderer.log`.
- If `browser_snapshot` returns `ECONNREFUSED`, the app isn't running with CDP enabled — follow the setup steps above.

## Common Pitfalls

1. **PTY resize after exit**: PTYs must be cleaned up on exit. Use `removePty()` in exit handlers.
2. **Worktree path resolution**: Always resolve paths from `WorktreeService`, not manually.
3. **IPC type safety**: Define all new IPC methods in `electron-api.d.ts`.
4. **Native module issues**: After updating node-pty/sqlite3/keytar, run `pnpm run rebuild`. Last resort: `pnpm run reset`.
5. **Monaco disposal**: Editor instances must be disposed to prevent memory leaks.
6. **CLI not found in agent**: If agents can't find `gh`, `codex`, etc., the PATH setup in `main.ts` may need updating for the platform.

## Risky Areas

- `src/main/db/**` + `drizzle/` — Schema migrations; mismatches can corrupt user data
- `build/` entitlements and updater config — Incorrect changes break signing/auto-update
- Native dependencies (`sqlite3`, `node-pty`, `keytar`) — Rebuilding is slow; avoid upgrading casually
- PTY/terminal management — Race conditions or unhandled exits can kill agent runs

## Pre-PR Checklist

- [ ] Dev server runs: `pnpm run d` starts cleanly
- [ ] Checks pass: `pnpm run lint`, `pnpm run type-check`, `pnpm exec vitest run`
- [ ] No stray build artifacts or secrets committed
- [ ] Schema or config changes documented

## Git Workflow

- Worktrees: `../worktrees/{workspace-name}-{timestamp}`, agents run there
- Conventional commits: `feat:`, `fix:`, `refactor:`, `docs:`, `chore:`, `test:`
- Example: `fix(agent): resolve worktree path issue (#123)`

## Key Configuration Files

- `vite.config.ts` — Renderer build + Vitest test config
- `drizzle.config.ts` — Database migration config (supports `VALKYR_DB_FILE` override)
- `tsconfig.json` — Renderer/shared TypeScript config
- `tsconfig.main.json` — Main process TypeScript config (CommonJS output)
- `tailwind.config.js` — Tailwind configuration
- `.nvmrc` — Node version (22.22.0)
- Electron Builder config is in `package.json` under `"build"` key

## Project Documentation (`.notes/`)

The `.notes/` directory contains planning and research documents (gitignored):

- **`competitors.md`** — Direct competitors (Termpad, Ona, Superset, Soloterm, Conductor) and adjacent competitors (Cursor, Windsurf, Aider, OpenHands, Devin). Includes research on status detection approaches used in the industry.
- **`plan.md`** — Implementation plans for major features. Current: Status Detection Refactor using Claude Code's official APIs (`--output-format stream-json`, hooks system) to replace fragile regex-based terminal parsing.

### Competitors Overview

| Direct | Adjacent |
|--------|----------|
| [Termpad](https://termpad.com) | Cursor IDE |
| [Ona](https://ona.com) | Windsurf/Codeium |
| [Superset](https://superset.sh) | GitHub Copilot Workspace |
| [Soloterm](https://soloterm.com) | Aider |
| [Conductor](https://conductor.build) | OpenHands, Devin |

### Key Protocols to Monitor

- **AG-UI Protocol** — Open standard for agent-UI communication
- **MCP** — Anthropic's Model Context Protocol for tool/context integration
- **A2A Protocol** — Google/Linux Foundation agent-to-agent standard
